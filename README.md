## Инструкция по эксплуатации Telegram-бота для сотрудников рекламного агентства (легенда по ТЗ)

### Описание
Этот Telegram-бот предоставляет сотрудникам рекламного агентства доступ к сервисам искусственного интеллекта:
- **Текстовая модель:** ChatGPT-3.5-turbo
- **Модель для генерации изображений:** Kandinsky 3.1

### Основные команды
- `/start` - Запустить бота
- `/help` - Помощь
- `/history` - Показать историю запросов
- `/high` - Показать запросы с наибольшей стоимостью
- `/low` - Показать запросы с наименьшей стоимостью

### Использование
1. **Запуск бота**
   - Введите команду `/start` для начала работы с ботом.
   - Бот поприветствует вас и предложит список доступных команд.

2. **Получение помощи**
   - Введите команду `/help` для получения информации о доступных командах и их описания.

3. **Генерация текста с помощью ChatGPT-3.5-turbo**
   - Отправьте текстовое сообщение с запросом, например, "Напиши рекламный текст для нового продукта: <описание продукта>".
   - Бот ответит сгенерированным текстом от модели ChatGPT-3.5-turbo.

4. **Генерация изображений с помощью Kandinsky 3.1**
   - Отправьте текстовое сообщение с запросом на изображение, например, "Нарисуй логотип для нового продукта <описание продукта>".
   - Бот ответит сгенерированным изображением от модели Kandinsky 3.1.

5. **Просмотр истории запросов**
   - Введите команду `/history` для отображения истории ваших запросов.

6. **Просмотр запросов с наибольшей стоимостью**
   - Введите команду `/high` для отображения запросов с наибольшей стоимостью, отсортированных по убыванию стоимости.

7. **Просмотр запросов с наименьшей стоимостью**
   - Введите команду `/low` для отображения запросов с наименьшей стоимостью, отсортированных по возрастанию стоимости.

### Пример использования
1. **Запуск бота**
   ```
   /start
   ```
   Ответ:
   ```
   Привет! Я бот, который поможет вам с генерацией текста и изображений. Используйте команды ниже для работы со мной:
   /help - Помощь
   /history - Показать историю запросов
   /high - Показать запросы с наибольшей стоимостью
   /low - Показать запросы с наименьшей стоимостью
   ```

2. **Генерация текста**
   ```
   Напиши рекламный текст для нового продукта <описание продукта>
   ```
   Ответ:
   ```
   Новый продукт - это инновационное решение, которое изменит ваш взгляд на мир! Попробуйте его сегодня и ощутите разницу!
   ```

3. **Генерация изображения**
   ```
   Нарисуй логотип для нового продукта <описание продукта и требований к логотипу>
   ```
   Ответ:
   ```
   [Изображение логотипа]
   ```

4. **Просмотр истории запросов**
   ```
   /history
   ```
   Ответ:
   ```
   1. Пользователю предлагается на выбор сформировать отчет о его запросах к ИИ, генерирующему текстовые ответы, за определенные промежутки времени, а также - всю историю запросов.
   2. После выбора пользователя путем нажатия соответствующей кнопки формируется отчет, который записывается в текстовый файл, который отправляется в чат пользователю.  
   ```

5. **Просмотр запросов с максимальной и минимальной стоимостью**
   ```
   /high | /low
   ```
   Ответ:
   ```
   1. Пользователю предлагается на выбор сформировать отчет о запросах к ИИ, генерирующему текстовые ответы, отсортированные по убыванию или возрастанию стоимости (в потраченных токенах) - в определенном количестве, в т.ч. - указанном пользователем.
   2. После выбора пользователя путем нажатия соответствующей кнопки формируется отчет, который записывается в текстовый файл, который отправляется в чат пользователю.  
   ```


#### Использованные технологии
- **Язык программирования:** Python 3.12
- **Фреймворк для бота**: aiogram - асинхронный фреймворк для создания ботов в Telegram
- **СУБД:** PostgreSQL - мощная объектно-реляционная СУБД с открытым исходным кодом
- **ORM:** SQLAlchemy (асинхронный интерфейс) - используется для взаимодействия с базой данных.
- **Модели искусственного интеллекта:**
  - ChatGPT-3.5-turbo (OpenAI): Используется для взаимодействия с моделью ChatGPT-3.5-turbo.
  - Kandinsky 3.1: Используется для генерации изображений по текстовым запросам через REST API.
- **Логирование:** Loguru - удобная библиотека для логирования в Python.
- **Асинхронность:** asyncio
- **HTTP-клиент:** requests
- **Паттерны проектирования:**
  - **Middleware:** Антифлуд и проверка старых запросов
  - **Singleton:** Логгер Loguru
  - **Factory:** Генераторы изображений и текста
- **Парадигмы ООП:**
  - **Инкапсуляция:** Классы для работы с API (Text2ImageAPI)
  - **Полиморфизм:** Различные генераторы (GPT и Kandinsky)
  - **Наследование:** Middleware (Антифлуд и проверка старых запросов)
- **Стратегии обработки ошибок:**
  - **Backoff:** Перезапуск основного цикла работы бота в случае ошибок соединения
- **Тестирование и статический анализ кода**:
  - **flake8**: Применяется для проверки стиля кода.
  - **mypy**: Используется для статической типизации и проверки типов в Python.


#### Структура проекта
- `main.py`: Основной файл запуска бота
- `mypy.ini`: Конфигурация для проверки типов
- `setup.cfg`: Конфигурация для линтера flake8
- `api/`: Модуль для работы с API моделей
  - `gpt_generators.py`: Генераторы текстов с помощью ChatGPT-3.5-turbo
  - `kandinsky_generators.py`: Генераторы изображений с помощью Kandinsky 3.1
- `config_data/`: Конфигурационные данные
  - `bot_commands.json`: Команды бота
  - `config.py`: Конфигурация проекта
  - `loguru_config.yaml`: Конфигурация логгера
- `handlers/`: Обработчики команд и сообщений
  - `custom_handlers/`: Обработчики пользовательских команд
  - `default_handlers/`: Обработчики стандартных команд
- `keyboards/`: Клавиатуры
- `middlewares/`: Мидлвейры для обработки сообщений
  - `antiflood.py`: Мидлвейр для защиты от спама
  - `check_old_requests.py`: Мидлвейр для проверки старых запросов
- `database/`: Модуль для работы с базой данных
  - `models.py`: Модели базы данных
  - `requests.py`: Модуль, выполняющий запросы к БД
- `utils/`: Утилиты и вспомогательные функции
  - `bot_loader.py`: Загрузчик бота
  - `loguru_logger.py`: Логгер Loguru
- `logs/`: Логи проекта
- `reports/`: Папка для хранения отчетов, формируемых ботом по запросу пользователей
- `states/`: Модуль для определения состояний, используемых в работе бота

#### Основной функционал
- **Асинхронный запуск и перезапуск бота**
  - Основной цикл работы бота с обработкой исключений и перезапуском (`main_loop` в `main.py`).
- **Обработка команд и сообщений**
  - Роутеры для регистрации обработчиков команд и сообщений.
- **Генерация текста и изображений**
  - Асинхронные функции для взаимодействия с моделями ChatGPT-3.5-turbo и Kandinsky 3.1.
- **История запросов**
  - Сохранение и отображение истории запросов пользователей.
- **Мидлвейры**
  - Антифлуд и проверка устаревших запросов.

#### Заключение
Проект представляет собой функционального Telegram-бота, который предоставляет сотрудникам рекламного агентства доступ к современным сервисам искусственного интеллекта. Бот реализован с использованием лучших практик программирования и проектирования, что делает его надежным и масштабируемым инструментом.